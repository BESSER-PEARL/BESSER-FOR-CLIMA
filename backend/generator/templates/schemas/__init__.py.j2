"""
Pydantic schemas for request/response validation.
"""
from pydantic import BaseModel, Field, field_validator
from typing import List, Optional, Dict, Any, Union, Literal
from datetime import datetime
from enum import Enum


# Base schemas
class BaseSchema(BaseModel):
    """Base schema with common configuration."""
    
    class Config:
        from_attributes = True
        use_enum_values = True


{% for enum in enumerations %}
# {{ enum.name }} Enum
class {{ enum.name }}(str, Enum):
    {% for literal in enum.literals %}
    {{ literal.name.upper() }} = "{{ literal.name.lower() }}"
    {% endfor %}

{% endfor %}

{%- for class in classes %}
{%- if not has_polymorphic_parent(class) %}

# {{ class.name }} schemas
class {{ class.name }}Base(BaseSchema):

    {% for attr in class.attributes %}
    {% if attr.name not in ['id', 'created_at', 'updated_at', 'type'] %}
    {% set is_optional = attr.multiplicity.min == 0 %}
    {% if is_optional %}
    {{ attr.name }}: Optional[{{ get_python_type(attr.type) }}] = {% if attr.metadata and attr.metadata.default is defined %}Field({{ attr.metadata.default }}{% else %}None{% endif %}{% if get_python_type(attr.type) == 'str' and get_string_length(attr) %}, max_length={{ get_string_length(attr) }}{% endif %})
    {% else %}
    {{ attr.name }}: {{ get_python_type(attr.type) }} = Field(...{% if get_python_type(attr.type) == 'str' %}, min_length=1, max_length={{ get_string_length(attr) }}{% endif %})
    {% endif %}
    {% endif %}
    {% endfor %}


class {{ class.name }}Create({{ class.name }}Base):
    {%- for end in get_foreign_key_associations(class) %}
    {% if end.multiplicity.min > 0 %}
    {{ end.name }}_id: int = Field(..., gt=0)
    {% else %}
    {{ end.name }}_id: Optional[int] = Field(None, gt=0)
    {% endif %}
    {% endfor %}


class {{ class.name }}Update(BaseSchema):
    {% for attr in class.attributes %}
    {% if attr.name not in ['id', 'created_at', 'updated_at', 'type'] %}
    {{ attr.name }}: Optional[{{ get_python_type(attr.type) }}] = Field(None{% if get_python_type(attr.type) == 'str' %}, min_length=1, max_length={{ get_string_length(attr) }}{% endif %})
    {% endif %}
    {% endfor %}


class {{ class.name }}({{ class.name }}Base):
    id: int
    {% for end in get_foreign_key_associations(class) %}
    {% if end.multiplicity.min > 0 %}
    {{ end.name }}_id: int
    {% else %}
    {{ end.name }}_id: Optional[int]
    {% endif %}
    {% endfor %}
    {%- if has_timestamps(class) %}
    created_at: datetime
    updated_at: datetime
    {%- endif %}
    {% for end in get_navigable_associations(class) %}
    {% if end.multiplicity.max == 1 %}
    {% if end.multiplicity.min == 0 %}
    {{ end.name }}: Optional["{{ end.type.name }}"] = None
    {%- else %}
    {{ end.name }}: "{{ end.type.name }}"
    {% endif %}
    {% else %}
    {{ end.name }}: List["{{ end.type.name }}"] = []
    {% endif %}
    {%- endfor %}

{% else %}
{%- set parent_class = class.parents() | list | first %}

# {{ class.name }} schemas
class {{ class.name }}Create({{ parent_class.name }}Create):
    type: Literal["{{ class.name.lower() }}"] = "{{ class.name.lower() }}"
    {% for attr in class.attributes %}
    {% if attr.name not in ['id', 'created_at', 'updated_at'] %}
    {% set is_optional = attr.multiplicity.min == 0 %}
    {%if is_optional %}
    {{ attr.name }}: Optional[{{ get_python_type(attr.type) }}] = {% if attr.metadata and attr.metadata.default is defined %}Field({{ attr.metadata.default }}{% if get_python_type(attr.type) == 'str' and get_string_length(attr) %}, max_length={{ get_string_length(attr) }}{% endif %}){% else %}None{% endif %}
    {% else %}
    {{ attr.name }}: {{ get_python_type(attr.type) }} = Field(...{% if get_python_type(attr.type) == 'str' %}, min_length=1, max_length={{ get_string_length(attr) }}{% endif %})
    {% endif %}
    {% endif %}
    {% endfor %}


class {{ class.name }}({{ parent_class.name }}):
    {% for attr in class.attributes %}
    {% if attr.name not in ['id', 'created_at', 'updated_at'] %}
    {% set is_optional = attr.multiplicity.min == 0 %}
    {% if is_optional %}
    {{ attr.name }}: Optional[{{ get_python_type(attr.type) }}]
    {% else %}
    {{ attr.name }}: {{ get_python_type(attr.type) }}
    {% endif %}
    {%- endif %}
    {%- endfor %}

{% endif %}
{% endfor %}

# Response wrapper schemas
class PaginatedResponse(BaseSchema):
    """Generic paginated response."""
    items: List[Any]
    total: int
    page: int
    per_page: int
    has_next: bool
    has_previous: bool


class ErrorResponse(BaseSchema):
    """Error response schema."""
    error: str
    message: str
    details: Optional[Dict[str, Any]] = None
